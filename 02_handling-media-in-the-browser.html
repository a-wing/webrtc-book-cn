<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>WebRTC 实时通信</title>
    <meta name="description" content="中文版 《 Real-Time Communication with WebRTC 》">
    <meta name="generator" content="VuePress 1.4.0">
    
    
    <link rel="preload" href="/webrtc-book-cn/assets/css/0.styles.4fb15f60.css" as="style"><link rel="preload" href="/webrtc-book-cn/assets/js/app.d61fefb3.js" as="script"><link rel="preload" href="/webrtc-book-cn/assets/js/2.68e3a1af.js" as="script"><link rel="preload" href="/webrtc-book-cn/assets/js/7.dfa8e81e.js" as="script"><link rel="prefetch" href="/webrtc-book-cn/assets/js/10.a89ec158.js"><link rel="prefetch" href="/webrtc-book-cn/assets/js/11.b91f01ff.js"><link rel="prefetch" href="/webrtc-book-cn/assets/js/12.6fd57a5b.js"><link rel="prefetch" href="/webrtc-book-cn/assets/js/13.d4881447.js"><link rel="prefetch" href="/webrtc-book-cn/assets/js/14.fa704c2e.js"><link rel="prefetch" href="/webrtc-book-cn/assets/js/15.47d07794.js"><link rel="prefetch" href="/webrtc-book-cn/assets/js/16.0f08ae19.js"><link rel="prefetch" href="/webrtc-book-cn/assets/js/3.9415203d.js"><link rel="prefetch" href="/webrtc-book-cn/assets/js/4.020bda45.js"><link rel="prefetch" href="/webrtc-book-cn/assets/js/5.01c71c81.js"><link rel="prefetch" href="/webrtc-book-cn/assets/js/6.870a9ffe.js"><link rel="prefetch" href="/webrtc-book-cn/assets/js/8.1c5fde37.js"><link rel="prefetch" href="/webrtc-book-cn/assets/js/9.aceaace1.js">
    <link rel="stylesheet" href="/webrtc-book-cn/assets/css/0.styles.4fb15f60.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/webrtc-book-cn/" class="home-link router-link-active"><!----> <span class="site-name">WebRTC 实时通信</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/webrtc-book-cn/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://t.me/webrtc_cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Telegram
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/a-wing/webrtc-book-cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/webrtc-book-cn/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://t.me/webrtc_cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Telegram
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/a-wing/webrtc-book-cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/webrtc-book-cn/" class="sidebar-link">关于</a></li><li><a href="/webrtc-book-cn/preface.html" class="sidebar-link">前言</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>目录</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/webrtc-book-cn/01_introduction.html" class="sidebar-link">第1章 简介</a></li><li><a href="/webrtc-book-cn/02_handling-media-in-the-browser.html" class="active sidebar-link">第2章 处理浏览器中的媒体</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/webrtc-book-cn/02_handling-media-in-the-browser.html#webrtc-的-10-个步骤" class="sidebar-link">WebRTC 的 10 个步骤</a></li><li class="sidebar-sub-header"><a href="/webrtc-book-cn/02_handling-media-in-the-browser.html#媒体捕获及数据流" class="sidebar-link">媒体捕获及数据流</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/webrtc-book-cn/02_handling-media-in-the-browser.html#流媒体-api" class="sidebar-link">流媒体 API</a></li><li class="sidebar-sub-header"><a href="/webrtc-book-cn/02_handling-media-in-the-browser.html#获取本地多媒体内容" class="sidebar-link">获取本地多媒体内容</a></li><li class="sidebar-sub-header"><a href="/webrtc-book-cn/02_handling-media-in-the-browser.html#url" class="sidebar-link">URL</a></li></ul></li><li class="sidebar-sub-header"><a href="/webrtc-book-cn/02_handling-media-in-the-browser.html#使用-getusermedia-api" class="sidebar-link">使用 getUserMedia() API</a></li><li class="sidebar-sub-header"><a href="/webrtc-book-cn/02_handling-media-in-the-browser.html#媒体模型" class="sidebar-link">媒体模型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/webrtc-book-cn/02_handling-media-in-the-browser.html#媒体约束" class="sidebar-link">媒体约束</a></li><li class="sidebar-sub-header"><a href="/webrtc-book-cn/02_handling-media-in-the-browser.html#使用约束" class="sidebar-link">使用约束</a></li></ul></li></ul></li><li><a href="/webrtc-book-cn/03_building-the-browser-RTC-trapezoid.html" class="sidebar-link">第3章 构建浏览器 RTC 梯形图：本地视角</a></li><li><a href="/webrtc-book-cn/04_the-need-for-a-signaling-channel.html" class="sidebar-link">第4章 需要信令通道</a></li><li><a href="/webrtc-book-cn/05_putting_it_all_together.html" class="sidebar-link">第5章 放在一起：拼凑出你的第一个 WebRTC 系统</a></li><li><a href="/webrtc-book-cn/06_advanced_features.html" class="sidebar-link">第6章 WebRTC API 的高级功能简介</a></li><li><a href="/webrtc-book-cn/07_webrtc_api_v1.html" class="sidebar-link">附录A WebRTC 1.0 APIs</a></li><li><a href="/webrtc-book-cn/about_the_authors.html" class="sidebar-link">关于本书和作者</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="第2章-处理浏览器中的媒体"><a href="#第2章-处理浏览器中的媒体" class="header-anchor">#</a> 第2章 处理浏览器中的媒体</h1> <p>在本章中，我们将开始研究 WebRTC 框架的细节，该框架基本上指定了一组 JavaScript API，用于开发基于 Web 的应用程序。
这些 API 一开始就被认为是用于实现基本用例的友好工具，例如一对一的音频/视频调用。 它们还应具有足够的灵活性，以保证专家开发人员可以实现各种复杂得多的使用场景。
因此，为程序员提供了一组 API，这些 API 可以大致分为三个逻辑组：</p> <ol><li>本地和远程音频和视频的获取和管理：</li></ol> <ul><li><code>MediaStream</code> 界面（以及 HTML5 <code>&lt;audio&gt;</code> 和 <code>&lt;video&gt;</code> 标签的相关用法）</li></ul> <ol start="2"><li>连接管理：</li></ol> <ul><li><code>RTCPeerConnection</code> 接口</li></ul> <ol start="3"><li>管理任意数据：</li></ol> <ul><li><code>RTCDataChannel</code> 接口</li></ul> <h2 id="webrtc-的-10-个步骤"><a href="#webrtc-的-10-个步骤" class="header-anchor">#</a> WebRTC 的 10 个步骤</h2> <p>以下 10 个步骤的步骤描述了 WebRTC API 的典型使用场景：</p> <ol><li>从本地设备（如麦克风、网络摄像头）创建一个 <code>MediaStream</code> 对象。</li> <li>从本地 <code>MediaStream</code> 获取 <em>URL Blob</em></li> <li>使用获取的 <em>URL Blob</em> 进行本地预览</li> <li>创建一个 <code>RTCPeerConnection</code> 对象</li> <li>将本地流添加到新创建的连接</li> <li>将你自己的会话描述发送到远程对等点  Send your own session description to the remote peer.</li> <li>从您的对等方接收远程会话描述  Receive the remote session description from your peer.</li> <li>处理收到的会话描述，并将远程流添加到您的 <code>RTCPeerConnection</code></li> <li>从远程流获取 <em>URL Blob</em></li> <li>使用获取的 <em>URL Blob</em> 播放远程对等方的音频和/或视频</li></ol> <p>我们将逐步完成上述步骤。 在本章的其余部分中，我们将涉及整个基于 WebRTC 的点对点通信生命周期的前三个阶段。 这意味着我们暂时将忘记远程对等方，而只专注于如何从浏览器中访问和使用本地音频和视频资源。 在执行此操作的同时，我们还将研究如何在限制条件下播放（例如，强制视频分辨率）。</p> <div class="custom-block danger"><p class="custom-block-title">WebRTC 支持的浏览器</p> <p>在撰写本文时，WebRTC API 在 Chrome，Firefox 和 Opera 中可用。 本书中包含的所有示例均已使用这些浏览器进行了测试。 为了简洁起见（由于 Opera 和 Chrome 在实现 API 方面几乎完全相同），我们从现在开始只将 Chrome 和 Firefox 作为运行客户端平台的示例。</p></div> <h2 id="媒体捕获及数据流"><a href="#媒体捕获及数据流" class="header-anchor">#</a> 媒体捕获及数据流</h2> <p>W3C Media Capture and Streams 文档定义了一组 JavaScript API，这些API使应用程序能够从平台请求音频和视频流，以及操纵和处理流数据。</p> <h3 id="流媒体-api"><a href="#流媒体-api" class="header-anchor">#</a> 流媒体 API</h3> <p><code>MediaStream</code> 接口用于表示媒体数据流。 流可以是输入或输出，也可以是本地或远程（例如，本地网络摄像头或远程连接）。 必须注意，单个 <code>MediaStream</code> 可以包含零个或多个轨道。 每个轨道都有一个对应的 <code>MediaStreamTrack</code> 对象，该对象代表用户代理中的特定媒体源。 <code>MediaStream</code> 中的所有轨道在渲染时进行同步。<code>MediaStreamTrack</code> 表示包含一个或多个通道的内容，其中，通道之间具有定义的已知的关系。 通道是此 API 规范中考虑的最小单位。 图2-1显示了由单个视频轨道和两个不同的音频（左声道和右声道）轨道组成的 <code>MediaStream</code></p> <p><img src="/webrtc-book-cn/assets/img/rcwr_0201.9228fb61.png" alt="图2-1"></p> <p>图2-1 由一个视频轨道和两个音频轨道组成的 <code>MediaStream</code></p> <p>W3C Media Capture Streams API 定义了两种方法 <code>getUserMedia()</code> 和 <code>createObjectUrl()</code>，以下各节对此进行了简要说明。</p> <h3 id="获取本地多媒体内容"><a href="#获取本地多媒体内容" class="header-anchor">#</a> 获取本地多媒体内容</h3> <p><code>getUserMedia()</code> API，通过指定一组（强制或可选）成功和失败的回调函数，Web 开发人员可以访问本地设备媒体（当前是音频和/或视频）</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">getUserMedia</span><span class="token punctuation">(</span>constraints<span class="token punctuation">,</span> successCallback<span class="token punctuation">,</span> errorCallback<span class="token punctuation">)</span>
</code></pre></div><p><code>getUserMedia()</code> 提示用户许可使用其网络摄像头或其他视频或音频输入。</p> <h3 id="url"><a href="#url" class="header-anchor">#</a> URL</h3> <p><code>createObjectUrl()</code> 方法指示浏览器创建和管理与本地文件或二进制对象（blob）关联的唯一URL：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">createObjectURL</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span>
</code></pre></div><p>它在 WebRTC 中的典型用法是从 <code>MediaStream</code> 对象开始创建 <em>Blob URL</em> 。 然后，将在 HTML 页面内使用 <em>Blob URL</em> 。 实际上，本地和远程流都需要此过程。</p> <h2 id="使用-getusermedia-api"><a href="#使用-getusermedia-api" class="header-anchor">#</a> 使用 <code>getUserMedia()</code> API</h2> <p>让我们开始使用 <code>getUserMedia()</code> API 调用及其返回的 <code>MediaStream</code> 对象。 先准备一个带有 JavaScript 代码的简单 HTML 页面，使我们可以访问本地视频资源并将其显示在 HTML5 <code>&lt;video&gt;</code> 标签中。示例 2-1 显示了我们为第一个示例构建的非常简单的页面。</p> <p>例2-1 我们的第一个启用 WebRTC 的 HTML 页面</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>getUserMedia very simple demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>mainDiv<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span><span class="token punctuation">&gt;</span></span>getUserMedia()<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">&gt;</span></span> very simple demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>With this example, we simply call <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span><span class="token punctuation">&gt;</span></span>getUserMedia()<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">&gt;</span></span> and display  the received stream inside an HTML5 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>video</span><span class="token punctuation">&gt;</span></span> element<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>View page source to access both HTML and JavaScript code...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>video</span> <span class="token attr-name">autoplay</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>video</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>js/getUserMedia.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>例2-2 文件 <code>js/getUserMedia.js</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Look after different browser vendors' ways of calling the getUserMedia()</span>
<span class="token comment">// API method:</span>
<span class="token comment">// Opera --&gt; getUserMedia</span>
<span class="token comment">// Chrome --&gt; webkitGetUserMedia</span>
<span class="token comment">// Firefox --&gt; mozGetUserMedia</span>

navigator<span class="token punctuation">.</span>getUserMedia <span class="token operator">=</span> navigator<span class="token punctuation">.</span>getUserMedia <span class="token operator">||</span> navigator<span class="token punctuation">.</span>webkitGetUserMedia <span class="token operator">||</span> navigator<span class="token punctuation">.</span>mozGetUserMedia<span class="token punctuation">;</span>

<span class="token comment">// Use constraints to ask for a video-only MediaStream:</span>
<span class="token keyword">var</span> constraints <span class="token operator">=</span> <span class="token punctuation">{</span>audio<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> video<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> video <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;video&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Callback to be called in case of success...</span>
<span class="token keyword">function</span> <span class="token function">successCallback</span><span class="token punctuation">(</span><span class="token parameter">stream</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">// Note: make the returned stream available to console for inspection</span>
  window<span class="token punctuation">.</span>stream <span class="token operator">=</span> stream<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span><span class="token constant">URL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Chrome case: URL.createObjectURL() converts a MediaStream to a blob URL</span>
    video<span class="token punctuation">.</span>src <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// Firefox and Opera: the src of the video can be set directly from the stream</span>
    video<span class="token punctuation">.</span>src <span class="token operator">=</span> stream<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// We're all set. Let's just play the video out!</span>
  video<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Callback to be called in case of failures...</span>
<span class="token keyword">function</span> <span class="token function">errorCallback</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;navigator.getUserMedia error: &quot;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Main action: just call getUserMedia() on the navigator object</span>
navigator<span class="token punctuation">.</span><span class="token function">getUserMedia</span><span class="token punctuation">(</span>constraints<span class="token punctuation">,</span> successCallback<span class="token punctuation">,</span> errorCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>以下屏幕截图显示了将页面加载到Chrome（图2-2）或Firefox（图2-3）时的外观。</p> <p><img src="/webrtc-book-cn/assets/img/rcwr_0202.e6c78f7c.png" alt="图2-2"></p> <p>图2-2 在 Chrome 中打开我们的第一个示例</p> <p><img src="/webrtc-book-cn/assets/img/rcwr_0203.a662de7f.png" alt="图2-3"></p> <p>图2-3 在 Firefox 中打开我们的第一个示例</p> <div class="custom-block danger"><p class="custom-block-title">在 Chrome 中打开 JavaScript 文件</p> <p>如果要在本地计算机上的 Google Chrome 中测试代码，则将面临一些挑战，因为由于安全限制，Chrome 默认不会加载本地文件。 为了解决这些问题，您必须在计算机上本地运行 Web 服务器并使用它来提供应用程序的文件，或者在启动浏览器时使用 <code>--allow-file-access-from-files</code> 选项。</p></div> <p>从上图中可以看出，两种浏览器在访问本地设备（在本例中为网络摄像头）之前都需要征得用户的同意。 在征得用户的明确同意后，浏览器最终将获取的 <code>MediaStream</code> 与页面相关联，如图 2-4 和 2-5 所示。</p> <p>注意：权限授予与网页的域相关，并且此权限不会扩展到网页上的弹出窗口和其他框架。</p> <p><img src="images/rcwr_0204.png" alt="图2-4"></p> <p>图2-4 在 Chrome 中显示获取的 <code>MediaStream</code></p> <p><img src="images/rcwr_0205.png" alt="图2-5"></p> <p>图2-5 在 Firefox 中显示获取的 <code>MediaStream</code></p> <p>深入研究上面报告的简单代码的一些细节，我们可以重点介绍如何调用 API 方法 <code>getUserMedia(constraints, successCallback, errorCallback)</code>，其参数具有以下含义：</p> <ul><li><code>constraints</code> 对象（请参阅第19页的“媒体约束”），用于指定对只收集本地视频感兴趣的穿戴者（<code>constraints = {audio: false, video: true}</code>）</li> <li><code>success callback</code> 如果调用，将传递给 <code>MediaStream</code>。在我们的例子中，首先将这样的 <code>MediaStream</code> 提供给控制台以供用户检查（<code>window.stream = stream;</code>）然后，将其附加到 <code>HTML5</code> 页面的 <code>&lt;video&gt;</code> 元素上并最终显示。 参考控制台对返回对象的检查，图 2-6 显示了在 Chrome 开发人员工具窗口中此类活动输出的快照。 每个 <code>MediaStream</code> 都有一个标签，并包含一个或多个表示音频或视频通道的 <code>MediaStreamTracks</code>。</li></ul> <p><img src="/webrtc-book-cn/assets/img/rcwr_0206.d6883cbd.png" alt="图2-6"></p> <p>图2-6 在 Chrome 的控制台中检查 <code>MediaStream</code></p> <p>关于返回的流如何附加到 <code>&lt;video&gt;</code> 元素，请注意，Chrome 要求转换为所谓的 Blob URL（<code>video.src = window.URL.createObjectURL(stream);</code>），而其他启用 WebRTC 的浏览器允许您按原样使用它（<code>video.src = stream;</code>）。</p> <ul><li><code>failure callback</code> 如果被调用，则传递给错误对象。 在我们的基本示例中，提到的回调仅将返回的错误记录到控制台（<code>console.log(&quot;navigator.getUserMedia error: &quot;, error);</code>）</li></ul> <h2 id="媒体模型"><a href="#媒体模型" class="header-anchor">#</a> 媒体模型</h2> <p>浏览器提供了从源(sources)到接收器(sinks)的媒体管道(pipeline)。 在浏览器中，接收器是 <code>&lt;img&gt;</code>，<code>&lt;video&gt;</code> 和 <code>&lt;audio&gt;</code> 标记。 来源可以是物理网络摄像头，麦克风，来自用户硬盘驱动器的本地视频或音频文件，网络资源或静态图像。 这些来源产生的媒体通常不会随时间变化。 这些源可以被认为是静态的。 向用户显示此类源的接收器（实际标签本身）具有用于控制源内容的各种控件。</p> <p><code>getUserMedia()</code> API方法添加了动态源，例如麦克风和相机。 这些来源的特性可能会根据应用需求而变化，这些来源本质上可以被认为是动态的。</p> <h3 id="媒体约束"><a href="#媒体约束" class="header-anchor">#</a> 媒体约束</h3> <p>约束是一项可选功能，用于限制 <code>MediaStream</code> 轨道源上允许的可变性范围。约束通过 <code>Constrainable</code> 接口在轨道上公开，该接口包括用于动态更改约束的 API</p> <p><code>getUserMedia()</code> 调用还允许在首次获取轨道时应用一组初始约束（例如，设置视频分辨率的值）</p> <p>约束的核心概念是一种功能，它由对象的属性或特征以及可能的值集组成，可以将值指定为范围或枚举。</p> <p>约束存储在 <code>track</code> 对象上，而不是对象资源。每个轨道都可以选择使用约束进行初始化。另外，可以在初始化之后通过专用的约束 API 添加约束。</p> <p>约束可以是可选的或强制的。可选约束由有序列表表示，而强制约束与无序集合相关。</p> <p>这样做是为了在发布 API 的最终版本之前为更多约束提供支持。约束包括高宽比，面向照相机的模式（正面或背面），音频和视频帧率，视频高度和宽度等等。</p> <h3 id="使用约束"><a href="#使用约束" class="header-anchor">#</a> 使用约束</h3> <p>在本节中，我们将快速了解如何使用 <code>getUserMedia()</code> 调用获取轨道时如何应用初始约束集。</p> <div class="custom-block danger"><p class="custom-block-title">WebRTC 浏览器中的 `getUserMedia()` 约束支持</p> <p>目前仅在 Chrome 中支持 <code>getUserMedia()</code> 约束。 本节中的示例将假定您使用此浏览器。</p></div> <p>首先，在 例2-3 中构建HTML页面。</p> <p>例2-3 播放和约束：在 HTML 页面</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token doctype">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;
		&quot;http://www.w3.org/TR/html4/loose.dtd&quot;&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>getUserMedia() and constraints<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>mainDiv<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span><span class="token punctuation">&gt;</span></span>getUserMedia()<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">&gt;</span></span>: playing with video constraints<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Click one of the below buttons to change video resolution...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>buttons<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>qvga<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>320x240<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>vga<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>640x480<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>hd<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>1280x960<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>dimensions<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>video</span> <span class="token attr-name">autoplay</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>video</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>js/getUserMedia_constraints.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>从 例2-3 中的代码片段和 图2-7 中的快照都可以看到，该页面包含三个按钮，每个按钮与以特定分辨率（从低分辨率到高清视频）表示的本地视频流相关联</p> <p><img src="images/rcwr_0207.png" alt="图2-7"></p> <p>图2-7 一个简单的 HTML 页面，显示 Chrome 中约束的使用</p> <p>例2-4 显示了用于获取本地视频流并明确定义的分辨率添加到网页的 JavaScript 代码</p> <p>例2-4 播放约束： <code>getUserMedia_constraints.js</code> 文件</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Define local variables associated with video resolution selection</span>
<span class="token comment">// buttons in the HTML page</span>
<span class="token keyword">var</span> vga Button <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;button#vga&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> qvgaButton <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;button#qvga&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> hdButton <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;button#hd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Video element in the HTML5 pagevar</span>
video <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;video&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// The local MediaStream to play with</span>
<span class="token keyword">var</span> stream<span class="token punctuation">;</span>

<span class="token comment">// Look after different browser vendors' ways of calling the</span>
<span class="token comment">// getUserMedia() API method:</span>
navigator<span class="token punctuation">.</span>getUserMedia <span class="token operator">=</span> navigator<span class="token punctuation">.</span>getUserMedia <span class="token operator">||</span>
  navigator<span class="token punctuation">.</span>webkitGetUserMedia <span class="token operator">||</span> navigator<span class="token punctuation">.</span>mozGetUserMedia<span class="token punctuation">;</span>

<span class="token comment">// Callback to be called in case of success...</span>
<span class="token keyword">function</span> <span class="token function">successCallback</span><span class="token punctuation">(</span><span class="token parameter">gotStream</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Make the stream available to the console for introspection</span>
  window<span class="token punctuation">.</span>stream <span class="token operator">=</span> gotStream<span class="token punctuation">;</span>

  <span class="token comment">// Attach the returned stream to the &lt;video&gt; element</span>
  <span class="token comment">// in the HTML page</span>
  video<span class="token punctuation">.</span>src <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Start playing video</span>
  video<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Callback to be called in case of failure...</span>
<span class="token keyword">function</span> <span class="token function">errorCallback</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;navigator.getUserMedia error: &quot;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Constraints object for low resolution video</span>
<span class="token keyword">var</span> qvgaConstraints <span class="token operator">=</span> <span class="token punctuation">{</span>
  video<span class="token operator">:</span> <span class="token punctuation">{</span>
    mandatory<span class="token operator">:</span> <span class="token punctuation">{</span>
      maxWidth<span class="token operator">:</span> <span class="token number">320</span><span class="token punctuation">,</span>
      maxHeight<span class="token operator">:</span> <span class="token number">240</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Constraints object for standard resolution video</span>
<span class="token keyword">var</span> vgaConstraints <span class="token operator">=</span> <span class="token punctuation">{</span>
  video<span class="token operator">:</span> <span class="token punctuation">{</span>
    mandatory<span class="token operator">:</span> <span class="token punctuation">{</span>
      maxWidth<span class="token operator">:</span> <span class="token number">640</span><span class="token punctuation">,</span>
      maxHeight<span class="token operator">:</span> <span class="token number">480</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Constraints object for high resolution video</span>
<span class="token keyword">var</span> hdConstraints <span class="token operator">=</span> <span class="token punctuation">{</span>
  video<span class="token operator">:</span> <span class="token punctuation">{</span>
    mandatory<span class="token operator">:</span> <span class="token punctuation">{</span>
      minWidth<span class="token operator">:</span> <span class="token number">1280</span><span class="token punctuation">,</span>
      minHeight<span class="token operator">:</span> <span class="token number">960</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Associate actions with buttons:</span>
qvgaButton<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">getMedia</span><span class="token punctuation">(</span>qvgaConstraints<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

vgaButton<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">getMedia</span><span class="token punctuation">(</span>vgaConstraints<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

hdButton<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">getMedia</span><span class="token punctuation">(</span>hdConstraints<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Simple wrapper for getUserMedia() with constraints object as</span>
<span class="token comment">// an input parameter</span>
<span class="token keyword">function</span> <span class="token function">getMedia</span><span class="token punctuation">(</span><span class="token parameter">constraints</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>stream<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    video<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    stream<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  navigator<span class="token punctuation">.</span><span class="token function">getUserMedia</span><span class="token punctuation">(</span>constraints<span class="token punctuation">,</span> successCallback<span class="token punctuation">,</span> errorCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>例2-4 中的代码非常简单。 核心部分与约束对象的正确定义有关，每个约束对象都可以作为输入参数传递给 <code>getUserMedia()</code> 函数。 其中包含的三个样本对象只是简单地指出，视频应视为强制性的，并根据视频的宽度和高度的下限进一步指定分辨率。 为了使读者了解其含义，图2-8 和 图2-9 分别显示了320×240 和 640×480 的分辨率流。</p> <p><img src="images/rcwr_0208.png" alt="图2-8"></p> <p>图2-8 在 Chrome 中显示 320×240 分辨率的视频</p> <p><img src="images/rcwr_0209.png" alt="图2-9"></p> <p>图2-9 在 Chrome 中显示 640×480 分辨率的视频</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/webrtc-book-cn/01_introduction.html" class="prev">
        第1章 简介
      </a></span> <span class="next"><a href="/webrtc-book-cn/03_building-the-browser-RTC-trapezoid.html">
        第3章 构建浏览器 RTC 梯形图：本地视角
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/webrtc-book-cn/assets/js/app.d61fefb3.js" defer></script><script src="/webrtc-book-cn/assets/js/2.68e3a1af.js" defer></script><script src="/webrtc-book-cn/assets/js/7.dfa8e81e.js" defer></script>
  </body>
</html>
