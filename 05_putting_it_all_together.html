<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>WebRTC 实时通信</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="中文版 《 Real-Time Communication with WebRTC 》">
    <link rel="preload" href="/webrtc-book-cn/assets/css/0.styles.80f6cb28.css" as="style"><link rel="preload" href="/webrtc-book-cn/assets/js/app.2e33468f.js" as="script"><link rel="preload" href="/webrtc-book-cn/assets/js/2.f12a4af1.js" as="script"><link rel="preload" href="/webrtc-book-cn/assets/js/4.d764a0db.js" as="script"><link rel="prefetch" href="/webrtc-book-cn/assets/js/10.52500e1d.js"><link rel="prefetch" href="/webrtc-book-cn/assets/js/11.d77e547d.js"><link rel="prefetch" href="/webrtc-book-cn/assets/js/12.a1eda00e.js"><link rel="prefetch" href="/webrtc-book-cn/assets/js/13.dde175cd.js"><link rel="prefetch" href="/webrtc-book-cn/assets/js/14.08247bd0.js"><link rel="prefetch" href="/webrtc-book-cn/assets/js/15.10fb4035.js"><link rel="prefetch" href="/webrtc-book-cn/assets/js/3.87ec8dd3.js"><link rel="prefetch" href="/webrtc-book-cn/assets/js/5.73bf27b5.js"><link rel="prefetch" href="/webrtc-book-cn/assets/js/6.c2d6bf34.js"><link rel="prefetch" href="/webrtc-book-cn/assets/js/7.9795fe9e.js"><link rel="prefetch" href="/webrtc-book-cn/assets/js/8.0d032992.js"><link rel="prefetch" href="/webrtc-book-cn/assets/js/9.57ae7319.js">
    <link rel="stylesheet" href="/webrtc-book-cn/assets/css/0.styles.80f6cb28.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/webrtc-book-cn/" class="home-link router-link-active"><!----> <span class="site-name">WebRTC 实时通信</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/webrtc-book-cn/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://t.me/webrtc_cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Telegram
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/a-wing/webrtc-book-cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/webrtc-book-cn/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://t.me/webrtc_cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Telegram
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/a-wing/webrtc-book-cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/webrtc-book-cn/" aria-current="page" class="sidebar-link">关于</a></li><li><a href="/webrtc-book-cn/preface.html" class="sidebar-link">前言</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>目录</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/webrtc-book-cn/01_introduction.html" class="sidebar-link">第1章 简介</a></li><li><a href="/webrtc-book-cn/02_handling-media-in-the-browser.html" class="sidebar-link">第2章 处理浏览器中的媒体</a></li><li><a href="/webrtc-book-cn/03_building-the-browser-RTC-trapezoid.html" class="sidebar-link">第3章 构建浏览器 RTC 梯形图：本地视角</a></li><li><a href="/webrtc-book-cn/04_the-need-for-a-signaling-channel.html" class="sidebar-link">第4章 需要信令通道</a></li><li><a href="/webrtc-book-cn/05_putting_it_all_together.html" aria-current="page" class="active sidebar-link">第5章 放在一起：拼凑出你的第一个 WebRTC 系统</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/webrtc-book-cn/05_putting_it_all_together.html#完整的-webrtc-呼叫流程" class="sidebar-link">完整的 WebRTC 呼叫流程</a></li><li class="sidebar-sub-header"><a href="/webrtc-book-cn/05_putting_it_all_together.html#initiator-加入频道" class="sidebar-link">Initiator 加入频道</a></li><li class="sidebar-sub-header"><a href="/webrtc-book-cn/05_putting_it_all_together.html#joiner-加入频道" class="sidebar-link">Joiner 加入频道</a></li><li class="sidebar-sub-header"><a href="/webrtc-book-cn/05_putting_it_all_together.html#initiator-开始协商" class="sidebar-link">Initiator 开始协商</a></li><li class="sidebar-sub-header"><a href="/webrtc-book-cn/05_putting_it_all_together.html#joiner-管理-initiator-的-offer" class="sidebar-link">Joiner 管理 Initiator 的 offer</a></li><li class="sidebar-sub-header"><a href="/webrtc-book-cn/05_putting_it_all_together.html#ice-候选人交换" class="sidebar-link">ICE 候选人交换</a></li><li class="sidebar-sub-header"><a href="/webrtc-book-cn/05_putting_it_all_together.html#joiner-的-answer" class="sidebar-link">Joiner 的 answer</a></li><li class="sidebar-sub-header"><a href="/webrtc-book-cn/05_putting_it_all_together.html#开始点对点" class="sidebar-link">开始点对点！</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/webrtc-book-cn/05_putting_it_all_together.html#使用-data-channel" class="sidebar-link">使用 Data Channel</a></li></ul></li><li class="sidebar-sub-header"><a href="/webrtc-book-cn/05_putting_it_all_together.html#快速浏览-chrome-webrtc-内部工具" class="sidebar-link">快速浏览 Chrome WebRTC 内部工具</a></li></ul></li><li><a href="/webrtc-book-cn/06_advanced_features.html" class="sidebar-link">第6章 WebRTC API 的高级功能简介</a></li><li><a href="/webrtc-book-cn/07_webrtc_api_v1.html" class="sidebar-link">附录A WebRTC 1.0 APIs</a></li><li><a href="/webrtc-book-cn/about_the_authors.html" class="sidebar-link">关于本书和作者</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="第5章-放在一起-拼凑出你的第一个-webrtc-系统"><a href="#第5章-放在一起-拼凑出你的第一个-webrtc-系统" class="header-anchor">#</a> 第5章 放在一起：拼凑出你的第一个 WebRTC 系统</h1> <p>我们终于准备好将所有部分放在一起，并构建我们的第一个 WebRTC 应用程序。
在本章中，通过利用像我们在 第4章 中描述的那样的信令服务器，我们将在分布式方案中实现浏览器 RTC 梯形。
基本上，我们将以 第3章 的运行示例为例，并使其也超出本地视角的范围。</p> <p>我们将展示如何使用信令信道来允许两个对等方交换用户媒体信息，会话描述 和 ICE 协议候选者。
我们还将重点介绍如何仅在设置阶段证明信令服务器角色是基础。
实际上，一旦成功交换了上述信息，通信模式便切换为纯对等，服务器本身不参与实际的数据交换。</p> <h2 id="完整的-webrtc-呼叫流程"><a href="#完整的-webrtc-呼叫流程" class="header-anchor">#</a> 完整的 WebRTC 呼叫流程</h2> <p>图5-1、5-2 和 5-3 提供了与完整的 WebRTC 呼叫流程图，该流程涉及一个信道发起方，一个信道连接器以及在信道建立时在它们之间中继消息的信令服务器。</p> <p><img src="/webrtc-book-cn/assets/img/rcwr_0501.234af3b4.png" alt="图5-1"></p> <p>图5-1 WebRTC 调用流程：序列图，第 1 部分</p> <p><img src="/webrtc-book-cn/assets/img/rcwr_0502.682435b0.png" alt="图5-2"></p> <p>图5-2 WebRTC 调用流程：序列图，第 2 部分</p> <p><img src="/webrtc-book-cn/assets/img/rcwr_0503.6e06ab73.png" alt="图5-3"></p> <p>图5-3 WebRTC 调用流程：序列图，第 3 部分</p> <p>序列图通过以下步骤变化：</p> <ol><li>Initiator 连接到服务器，并使其创建信令通道。</li> <li>Initiator（在获得用户同意后）可以访问用户的媒体。</li> <li>Joiner 连接到服务器并加入频道。</li> <li>当 Joiner 还可以访问本地用户的媒体时，将通过服务器将一条消息发送给 Initiator ，从而触发协商过程：</li></ol> <ul><li>发起方创建 <code>PeerConnection</code> ，向其添加本地流，创建 SDP <code>offer</code>，然后通过信令服务器将其发送到 Joiner。</li> <li>收到 SDP <code>offer</code> 后，Joiner 会通过创建 <code>PeerConnection</code> 对象，向其添加本地流并构建 SDP <code>answer</code> 以（通过服务器）发送回远程方来镜像发起方的行为。</li></ul> <ol start="5"><li>在协商过程中，双方利用信令服务器交换网络可达性信息（以 ICE 协议候选地址的形式）。</li> <li>当 Initiator 收到 Joiner 对其自己的<code>offer</code> 返回的 <code>answer</code> 时，协商过程结束：</li></ol> <ul><li>双方通过利用各自的 <code>PeerConnection</code> 对象切换到对等通信，<code>PeerConnection</code> 对象还配备了可用于直接交换文本消息的数据通道(data channel)。</li></ul> <p>在以下各节中，我们将通过详细分析每个步骤来逐步完成这些步骤。 在进行此操作之前，让我们介绍作为本章的运行示例而设计的简单 Web 应用程序。
HTML 代码在 例5-1 中。</p> <p>例5-1 简单的 WebRTC 应用程序</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Very simple WebRTC application with a Node.js signaling server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>mainDiv<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">border</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>100%<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">&gt;</span></span>
            Local video
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">&gt;</span></span>
            Remote video
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>video</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>localVideo<span class="token punctuation">&quot;</span></span> <span class="token attr-name">autoplay</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>video</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>video</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>remoteVideo<span class="token punctuation">&quot;</span></span> <span class="token attr-name">autoplay</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>video</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name">align</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>center<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span> <span class="token attr-name">rows</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>4<span class="token punctuation">&quot;</span></span> <span class="token attr-name">cols</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>60<span class="token punctuation">&quot;</span></span><span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dataChannelSend<span class="token punctuation">&quot;</span></span> <span class="token attr-name">disabledplaceholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>This will be enabled once the data channel is up...<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name">align</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>center<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span> <span class="token attr-name">rows</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>4<span class="token punctuation">&quot;</span></span> <span class="token attr-name">cols</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>60<span class="token punctuation">&quot;</span></span><span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dataChannelReceive<span class="token punctuation">&quot;</span></span> <span class="token attr-name">disabled</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name">align</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>center<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sendButton<span class="token punctuation">&quot;</span></span> <span class="token attr-name">disabled</span><span class="token punctuation">&gt;</span></span>Send<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/socket.io/socket.io.js<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>js/lib/adapter.js<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>js/completeNodeClientWithDataChannel.js<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>本地视频以及本地数据通道信息显示在页面的左侧，而远程视频和数据则显示在窗口的右侧。 该页面涉及三个脚本文件，第一个是已经介绍的 socket.io 库（请参阅第66页的 “ socket.io JavaScript 库” ）。 至于第二个文件（adapter.js），它是一个方便的 JavaScript 填充程序库，可通过适当抽象浏览器前缀以及其他浏览器差异和供应商当前解释规格的方式更改，来帮助程序员。 最后，<code>completeNodeClientWithDataChannel.js</code> 包含实际的客户端代码，并在 例5-2 中完整介绍了该示例，以使读者受益。 在本章的其余部分中，我们将深入研究该文件的详细信息。</p> <p>例5-2 <code>completeNodeClientWithDataChannel.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token comment">// Look after different browser vendors' ways of calling the getUserMedia()</span>
<span class="token comment">// API method:</span>
<span class="token comment">// Opera --&gt; getUserMedia</span>
<span class="token comment">// Chrome --&gt; webkitGetUserMedia</span>
<span class="token comment">// Firefox --&gt; mozGetUserMedia</span>
navigator<span class="token punctuation">.</span>getUserMedia <span class="token operator">=</span> navigator<span class="token punctuation">.</span>getUserMedia <span class="token operator">||</span>navigator<span class="token punctuation">.</span>webkitGetUserMedia <span class="token operator">||</span> navigator<span class="token punctuation">.</span>mozGetUserMedia<span class="token punctuation">;</span>

<span class="token comment">// Clean-up function:</span>
<span class="token comment">// collect garbage before unloading browser's window</span>
window<span class="token punctuation">.</span><span class="token function-variable function">onbeforeunload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token function">hangup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Data channel information</span>
<span class="token keyword">var</span> sendChannel<span class="token punctuation">,</span> receiveChannel<span class="token punctuation">;</span>
<span class="token keyword">var</span> sendButton <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;sendButton&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> sendTextarea <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;dataChannelSend&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> receiveTextarea <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;dataChannelReceive&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// HTML5 &lt;video&gt; elements</span>
<span class="token keyword">var</span> localVideo <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#localVideo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> remoteVideo <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#remoteVideo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Handler associated with Send button</span>
sendButton<span class="token punctuation">.</span>onclick <span class="token operator">=</span> sendData<span class="token punctuation">;</span>

<span class="token comment">// Flags...</span>
<span class="token keyword">var</span> isChannelReady <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> isInitiator <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> isStarted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token comment">// WebRTC data structures</span>
<span class="token comment">// Streams</span>
<span class="token keyword">var</span> localStream<span class="token punctuation">;</span>
<span class="token keyword">var</span> remoteStream<span class="token punctuation">;</span>

<span class="token comment">// PeerConnection</span>
<span class="token keyword">var</span> pc<span class="token punctuation">;</span>

<span class="token comment">// PeerConnection ICE protocol configuration (either Firefox or Chrome)</span>
<span class="token keyword">var</span> pc_config <span class="token operator">=</span> webrtcDetectedBrowser <span class="token operator">===</span> <span class="token string">'firefox'</span> <span class="token operator">?</span>
  <span class="token punctuation">{</span><span class="token string">'iceServers'</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">'url'</span><span class="token operator">:</span><span class="token string">'stun:23.21.150.121'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span> <span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span> <span class="token constant">IP</span> address
  <span class="token punctuation">{</span><span class="token string">'iceServers'</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">'url'</span><span class="token operator">:</span> <span class="token string">'stun:stun.l.google.com:19302'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> pc_constraints <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">'optional'</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span><span class="token string">'DtlsSrtpKeyAgreement'</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> sdpConstraints <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Let's get started: prompt user for input (room name)</span>
<span class="token keyword">var</span> room <span class="token operator">=</span> <span class="token function">prompt</span><span class="token punctuation">(</span><span class="token string">'Enter room name:'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Connect to signaling server</span>
<span class="token keyword">var</span> socket <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8181&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Send 'Create or join' message to singnaling server</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>room <span class="token operator">!==</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Create or join room'</span><span class="token punctuation">,</span> room<span class="token punctuation">)</span><span class="token punctuation">;</span>
  socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'create or join'</span><span class="token punctuation">,</span> room<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Set getUserMedia constraints</span>
<span class="token keyword">var</span> constraints <span class="token operator">=</span> <span class="token punctuation">{</span>video<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> audio<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// From this point on, execution proceeds based on asynchronous events...</span>

<span class="token comment">// getUserMedia() handlers...</span>
<span class="token keyword">function</span> <span class="token function">handleUserMedia</span><span class="token punctuation">(</span><span class="token parameter">stream</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  localStream <span class="token operator">=</span> stream<span class="token punctuation">;</span>
  <span class="token function">attachMediaStream</span><span class="token punctuation">(</span>localVideo<span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Adding local stream.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token string">'got user media'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">handleUserMediaError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'navigator.getUserMedia error: '</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Server-mediated message exchanging...</span>

<span class="token comment">// 1. Server--&gt;Client...</span>
<span class="token comment">// Handle 'created' message coming back from server:</span>
<span class="token comment">// this peer is the initiator</span>
socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'created'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">room</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Created room '</span> <span class="token operator">+</span> room<span class="token punctuation">)</span><span class="token punctuation">;</span>
  isInitiator <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

  <span class="token comment">// Call getUserMedia()</span>
  navigator<span class="token punctuation">.</span><span class="token function">getUserMedia</span><span class="token punctuation">(</span>constraints<span class="token punctuation">,</span> handleUserMedia<span class="token punctuation">,</span> handleUserMediaError<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Getting user media with constraints'</span><span class="token punctuation">,</span> constraints<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">checkAndStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Handle 'full' message coming back from server:</span>
<span class="token comment">// this peer arrived too late :-(</span>
socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'full'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">room</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Room '</span> <span class="token operator">+</span> room <span class="token operator">+</span> <span class="token string">' is full'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Handle 'join' message coming back from server:</span>
<span class="token comment">// another peer is joining the channel</span>
socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'join'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">room</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Another peer made a request to join room '</span> <span class="token operator">+</span> room<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'This peer is the initiator of room '</span> <span class="token operator">+</span> room <span class="token operator">+</span> <span class="token string">'!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  isChannelReady <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Handle 'joined' message coming back from server:</span>
<span class="token comment">// this is the second peer joining the channel</span>
socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'joined'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">room</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'This peer has joined room '</span> <span class="token operator">+</span> room<span class="token punctuation">)</span><span class="token punctuation">;</span>
  isChannelReady <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

  <span class="token comment">// Call getUserMedia()</span>
  navigator<span class="token punctuation">.</span><span class="token function">getUserMedia</span><span class="token punctuation">(</span>constraints<span class="token punctuation">,</span> handleUserMedia<span class="token punctuation">,</span> handleUserMediaError<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Getting user media with constraints'</span><span class="token punctuation">,</span> constraints<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Server-sent log message...</span>
socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'log'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>console<span class="token punctuation">,</span> array<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Receive message from the other peer via the signaling server</span>
socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Received message:'</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>message <span class="token operator">===</span> <span class="token string">'got user media'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">checkAndStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'offer'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isInitiator <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isStarted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">checkAndStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    pc<span class="token punctuation">.</span><span class="token function">setRemoteDescription</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RTCSessionDescription</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">doAnswer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'answer'</span> <span class="token operator">&amp;&amp;</span> isStarted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pc<span class="token punctuation">.</span><span class="token function">setRemoteDescription</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RTCSessionDescription</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'candidate'</span> <span class="token operator">&amp;&amp;</span> isStarted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> candidate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RTCIceCandidate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      sdpMLineIndex<span class="token operator">:</span>message<span class="token punctuation">.</span>label<span class="token punctuation">,</span>candidate<span class="token operator">:</span>message<span class="token punctuation">.</span>candidate<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      pc<span class="token punctuation">.</span><span class="token function">addIceCandidate</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message <span class="token operator">===</span> <span class="token string">'bye'</span> <span class="token operator">&amp;&amp;</span> isStarted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">handleRemoteHangup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 2. Client--&gt;Server</span>

<span class="token comment">// Send message to the other peer via the signaling server</span>
<span class="token keyword">function</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Sending message: '</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Channel negotiation trigger function</span>
<span class="token keyword">function</span> <span class="token function">checkAndStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isStarted <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> localStream <span class="token operator">!=</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span> isChannelReady<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">createPeerConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    isStarted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isInitiator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">doCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// PeerConnection management...</span>
<span class="token keyword">function</span> <span class="token function">createPeerConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    pc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RTCPeerConnection</span><span class="token punctuation">(</span>pc_config<span class="token punctuation">,</span> pc_constraints<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pc<span class="token punctuation">.</span><span class="token function">addStream</span><span class="token punctuation">(</span>localStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pc<span class="token punctuation">.</span>onicecandidate <span class="token operator">=</span> handleIceCandidate<span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Created RTCPeerConnnection with:\n'</span> <span class="token operator">+</span><span class="token string">' config: \''</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>pc_config<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\'; \n'</span> <span class="token operator">+</span><span class="token string">' constraints: \''</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>pc_constraints<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Failed to create PeerConnection, exception: '</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Cannot create RTCPeerConnection object.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span>

  pc<span class="token punctuation">.</span>onaddstream <span class="token operator">=</span> handleRemoteStreamAdded<span class="token punctuation">;</span>

  pc<span class="token punctuation">.</span>onremovestream <span class="token operator">=</span> handleRemoteStreamRemoved<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isInitiator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>

      <span class="token comment">// Create a reliable data channel</span>
      sendChannel <span class="token operator">=</span> pc<span class="token punctuation">.</span><span class="token function">createDataChannel</span><span class="token punctuation">(</span><span class="token string">&quot;sendDataChannel&quot;</span><span class="token punctuation">,</span><span class="token punctuation">{</span>reliable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">'Created send data channel'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Failed to create data channel. '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">'createDataChannel() failed with exception: '</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    sendChannel<span class="token punctuation">.</span>onopen <span class="token operator">=</span> handleSendChannelStateChange<span class="token punctuation">;</span>
    sendChannel<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> handleMessage<span class="token punctuation">;</span>
    sendChannel<span class="token punctuation">.</span>onclose <span class="token operator">=</span> handleSendChannelStateChange<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// Joiner</span>
    pc<span class="token punctuation">.</span>ondatachannel <span class="token operator">=</span> gotReceiveChannel<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Data channel management</span>
<span class="token keyword">function</span> <span class="token function">sendData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> data <span class="token operator">=</span> sendTextarea<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isInitiator<span class="token punctuation">)</span> sendChannel<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> receiveChannel<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">'Sent data: '</span> <span class="token operator">+</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Handlers...</span>
<span class="token keyword">function</span> <span class="token function">gotReceiveChannel</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">'Receive Channel Callback'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  receiveChannel <span class="token operator">=</span> event<span class="token punctuation">.</span>channel<span class="token punctuation">;</span>
  receiveChannel<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> handleMessage<span class="token punctuation">;</span>
  receiveChannel<span class="token punctuation">.</span>onopen <span class="token operator">=</span> handleReceiveChannelStateChange<span class="token punctuation">;</span>
  receiveChannel<span class="token punctuation">.</span>onclose <span class="token operator">=</span> handleReceiveChannelStateChange<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">'Received message: '</span> <span class="token operator">+</span> event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  receiveTextarea<span class="token punctuation">.</span>value <span class="token operator">+=</span> event<span class="token punctuation">.</span>data <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">handleSendChannelStateChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> readyState <span class="token operator">=</span> sendChannel<span class="token punctuation">.</span>readyState<span class="token punctuation">;</span>
  <span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">'Send channel state is: '</span> <span class="token operator">+</span> readyState<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// If channel ready, enable user's input</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>readyState <span class="token operator">==</span> <span class="token string">&quot;open&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dataChannelSend<span class="token punctuation">.</span>disabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    dataChannelSend<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dataChannelSend<span class="token punctuation">.</span>placeholder <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    sendButton<span class="token punctuation">.</span>disabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    dataChannelSend<span class="token punctuation">.</span>disabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    sendButton<span class="token punctuation">.</span>disabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">handleReceiveChannelStateChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> readyState <span class="token operator">=</span> receiveChannel<span class="token punctuation">.</span>readyState<span class="token punctuation">;</span>
  <span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">'Receive channel state is: '</span> <span class="token operator">+</span> readyState<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// If channel ready, enable user's input</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>readyState <span class="token operator">==</span> <span class="token string">&quot;open&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dataChannelSend<span class="token punctuation">.</span>disabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    dataChannelSend<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dataChannelSend<span class="token punctuation">.</span>placeholder <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    sendButton<span class="token punctuation">.</span>disabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    dataChannelSend<span class="token punctuation">.</span>disabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    sendButton<span class="token punctuation">.</span>disabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// ICE candidates management</span>
<span class="token keyword">function</span> <span class="token function">handleIceCandidate</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'handleIceCandidate event: '</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>candidate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'candidate'</span><span class="token punctuation">,</span>
      label<span class="token operator">:</span> event<span class="token punctuation">.</span>candidate<span class="token punctuation">.</span>sdpMLineIndex<span class="token punctuation">,</span>
      id<span class="token operator">:</span> event<span class="token punctuation">.</span>candidate<span class="token punctuation">.</span>sdpMid<span class="token punctuation">,</span>
      candidate<span class="token operator">:</span> event<span class="token punctuation">.</span>candidate<span class="token punctuation">.</span>candidate
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'End of candidates.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Create Offer</span>
<span class="token keyword">function</span> <span class="token function">doCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Creating Offer...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  pc<span class="token punctuation">.</span><span class="token function">createOffer</span><span class="token punctuation">(</span>setLocalAndSendMessage<span class="token punctuation">,</span> onSignalingError<span class="token punctuation">,</span> sdpConstraints<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Signaling error handler</span>
<span class="token keyword">function</span> <span class="token function">onSignalingError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Failed to create signaling message : '</span> <span class="token operator">+</span> error<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Create Answer</span>
<span class="token keyword">function</span> <span class="token function">doAnswer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Sending answer to peer.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  pc<span class="token punctuation">.</span><span class="token function">createAnswer</span><span class="token punctuation">(</span>setLocalAndSendMessage<span class="token punctuation">,</span> onSignalingError<span class="token punctuation">,</span> sdpConstraints<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Success handler for both createOffer()</span>
<span class="token comment">// and createAnswer()</span>
<span class="token keyword">function</span> <span class="token function">setLocalAndSendMessage</span><span class="token punctuation">(</span><span class="token parameter">sessionDescription</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  pc<span class="token punctuation">.</span><span class="token function">setLocalDescription</span><span class="token punctuation">(</span>sessionDescription<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sendMessage</span><span class="token punctuation">(</span>sessionDescription<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Remote stream handlers...</span>
<span class="token keyword">function</span> <span class="token function">handleRemoteStreamAdded</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Remote stream added.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">attachMediaStream</span><span class="token punctuation">(</span>remoteVideo<span class="token punctuation">,</span> event<span class="token punctuation">.</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Remote stream attached!!.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  remoteStream <span class="token operator">=</span> event<span class="token punctuation">.</span>stream<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">handleRemoteStreamRemoved</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Remote stream removed. Event: '</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Clean-up functions...</span>
<span class="token keyword">function</span> <span class="token function">hangup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hanging up.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token string">'bye'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">handleRemoteHangup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Session terminated.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  isInitiator <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  isStarted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sendChannel<span class="token punctuation">)</span> sendChannel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>receiveChannel<span class="token punctuation">)</span> receiveChannel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>pc<span class="token punctuation">)</span> pc<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  pc <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  sendButton<span class="token punctuation">.</span>disabled<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>根据 第4章 中包含的信息，读者在理解信令服务器的行为时应该不会遇到任何问题，信令服务器已作为 Node.js 应用程序编写，其代码复制如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> <span class="token keyword">static</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node-static'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Create a node-static server instance</span>
<span class="token keyword">var</span> file <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token keyword">static</span><span class="token punctuation">.</span>Server<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// We use the http module’s createServer function and</span>
<span class="token comment">// rely on our instance of node-static to serve the files</span>
<span class="token keyword">var</span> app <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  file<span class="token punctuation">.</span><span class="token function">serve</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8181</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Use socket.io JavaScript library for real-time web applications</span>
<span class="token keyword">var</span> io <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'socket.io'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Let's start managing connections...</span>
io<span class="token punctuation">.</span>sockets<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Handle 'message' messages</span>
  socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'S --&gt; got message: '</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// channel-only broadcast...</span>
    socket<span class="token punctuation">.</span>broadcast<span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>channel<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Handle 'create or join' messages</span>
  socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'create or join'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">room</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> numClients <span class="token operator">=</span> io<span class="token punctuation">.</span>sockets<span class="token punctuation">.</span><span class="token function">clients</span><span class="token punctuation">(</span>room<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>

    <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'S --&gt; Room '</span> <span class="token operator">+</span> room <span class="token operator">+</span> <span class="token string">' has '</span> <span class="token operator">+</span> numClients <span class="token operator">+</span> <span class="token string">' client(s)'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'S --&gt; Request to create or join room'</span><span class="token punctuation">,</span> room<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// First client joining...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>numClients <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      socket<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>room<span class="token punctuation">)</span><span class="token punctuation">;</span>
      socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'created'</span><span class="token punctuation">,</span> room<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>numClients <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Second client joining...</span>
      io<span class="token punctuation">.</span>sockets<span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span>room<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'join'</span><span class="token punctuation">,</span> room<span class="token punctuation">)</span><span class="token punctuation">;</span>
      socket<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>room<span class="token punctuation">)</span><span class="token punctuation">;</span>
      socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'joined'</span><span class="token punctuation">,</span> room<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// max two clients</span>
      socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'full'</span><span class="token punctuation">,</span> room<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> array <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;&gt;&gt;&gt; &quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arguments<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      array<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>arguments<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'log'</span><span class="token punctuation">,</span> array<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>基本上，服务器负责两种通道管理操作（在收到发起方的请求后创建，在第二个对等方到达时加入）和消息中继（在会话建立时）。 正如已经预期的那样，在成功实例化共享信令通道的两个浏览器之间的对等会话之后，它立即完成任务。</p> <p>现在，让我们开始完整的 WebRTC 示例演练。</p> <h2 id="initiator-加入频道"><a href="#initiator-加入频道" class="header-anchor">#</a> Initiator 加入频道</h2> <p>图5-4 显示了启动上一节中描述的示例 WebRTC 应用程序时，Initiator 采取的动作序列。</p> <p><img src="/webrtc-book-cn/assets/img/rcwr_0504.333501ed.png" alt="图5-4"></p> <p>图5-4 发起者加入频道</p> <p>如图所示，将网页加载到浏览器中后，首先会提示用户输入频道名称。 然后，对等方连接到信令服务器，并向其发送创建或加入消息。 这在下面的 JavaScript 代码段中进行了报告，并在 图5-5 的快照中也进行了显示：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Let's get started: prompt user for input (room name)</span>
<span class="token keyword">var</span> room <span class="token operator">=</span> <span class="token function">prompt</span><span class="token punctuation">(</span><span class="token string">'Enter room name:'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Connect to signalling server</span>
<span class="token keyword">var</span> socket <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8181&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Send 'create' or 'join' message to singnalling server</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>room <span class="token operator">!==</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Create or join room'</span><span class="token punctuation">,</span> room<span class="token punctuation">)</span><span class="token punctuation">;</span>
  socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'create or join'</span><span class="token punctuation">,</span> room<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/webrtc-book-cn/assets/img/rcwr_0505.8babaddb.png" alt="图5-5"></p> <p>图5-5 发起者在 Chrome 浏览器中加入</p> <p>当服务器收到创建或加入消息时，它将对等方识别为发起方，并创建与所需通道关联的服务器端房间。 最终它将创建的消息发送回客户端：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Handle 'create or join' messages</span>
socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'create or join'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">room</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> numClients <span class="token operator">=</span> io<span class="token punctuation">.</span>sockets<span class="token punctuation">.</span><span class="token function">clients</span><span class="token punctuation">(</span>room<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'S --&gt; Room '</span> <span class="token operator">+</span> room <span class="token operator">+</span> <span class="token string">' has '</span> <span class="token operator">+</span> numClients <span class="token operator">+</span> <span class="token string">' client(s)'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'S --&gt; Request to create or join room'</span><span class="token punctuation">,</span> room<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// First client joining...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>numClients <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>socket<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>room<span class="token punctuation">)</span><span class="token punctuation">;</span>
    socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'created'</span><span class="token punctuation">,</span> room<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>numClients <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token operator">...</span>
</code></pre></div><p>图5-6 显示了此阶段的服务器控制台。</p> <p><img src="/webrtc-book-cn/assets/img/rcwr_0506.8ffbfb8c.png" alt="图5-6"></p> <p>图5-6 信令服务器创建信令通道</p> <p>现在我们到达了客户端从服务器获取一条创建的消息并意识到它将扮演通道发起者的角色：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Handle 'created' message coming back from server:</span>
<span class="token comment">// this peer is the initiator</span>
socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'created'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">room</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Created room '</span> <span class="token operator">+</span> room<span class="token punctuation">)</span><span class="token punctuation">;</span>
  isInitiator <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
</code></pre></div><p>客户端执行的下一个动作是通过 <code>getUserMedia()</code> API调用来访问用户的媒体：</p> <p>图5-7 显示了在获得用户同意之前浏览器的窗口。</p> <p><img src="/webrtc-book-cn/assets/img/rcwr_0507.9d8e0782.png" alt="图5-7"></p> <p>图5-7 Initiator 征求用户同意</p> <p>以下快照报告了 <code>handleUserMedia()</code> 成功处理程序执行的操作：</p> <ol><li>检索到的视频流附加到 HTML 页面的本地 <code>&lt;video&gt;</code> 元素</li> <li>获取到的用户媒体消息发送给服务器</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Call getUserMedia()</span>
navigator<span class="token punctuation">.</span><span class="token function">getUserMedia</span><span class="token punctuation">(</span>constraints<span class="token punctuation">,</span> handleUserMedia<span class="token punctuation">,</span> handleUserMediaError<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Getting user media with constraints'</span><span class="token punctuation">,</span> constraints<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这些操作中的第一个操作的效果如 图5-8 所示。</p> <p><img src="images/rcwr_0508.png" alt="图5-8"></p> <p>图5-8 用户同意后的发起者</p> <p>下面是用于向服务器发送消息的 JavaScript 代码：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Send message to the other peer via the signaling server</span>
<span class="token keyword">function</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Sending message: '</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以下摘录中显示了与接收通用消息相关的服务器端行为。 服务器首先将一条日志消息（在 图5-8 下部的浏览器控制台中也可见）发送回客户端，然后将接收到的消息广播到远程方（如果存在）（不是这种情况） 在呼叫流程的这一点）：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Handle 'message' messages</span>
socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'S --&gt; got message: '</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// channel-only broadcast...</span>
  socket<span class="token punctuation">.</span>broadcast<span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>channel<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>通道启动程序执行的最后一个操作是 <code>checkAndStart()</code> 函数的执行，由于通道尚未准备好，在整个调用流程的此阶段，该函数实际上不执行任何操作：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">checkAndStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Do nothing if channel not ready...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isStarted <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> localStream <span class="token operator">!=</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span> isChannelReady<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
</code></pre></div><h2 id="joiner-加入频道"><a href="#joiner-加入频道" class="header-anchor">#</a> Joiner 加入频道</h2> <p>现在，让我们找出第二个同伴加入该频道时发生的情况。 相关的动作顺序如 图5-9 所示。</p> <p>该图的第一部分反映了发起方的行为，提示用户输入频道名称，并向服务器发送创建或加入消息。 这次在服务器端进行消息处理（图5-10 中报告了服务器的控制台），设想将联接消息发送到发起方（后者现在可以将通道标记为就绪），紧接着是对 Joiner 的联接响应 ：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>numClients <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Second client joining...</span>
  io<span class="token punctuation">.</span>sockets<span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span>room<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'join'</span><span class="token punctuation">,</span> room<span class="token punctuation">)</span><span class="token punctuation">;</span>
  socket<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>room<span class="token punctuation">)</span><span class="token punctuation">;</span>
  socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'joined'</span><span class="token punctuation">,</span> room<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// max two clients</span>
</code></pre></div><p>以下摘录显示了与接收加入消息关联的客户端操作：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Handle 'join' message coming back from server:</span>
<span class="token comment">// another peer is joining the channel</span>
socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'join'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">room</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Another peer made a request to join room '</span> <span class="token operator">+</span> room<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'This peer is the initiator of room '</span> <span class="token operator">+</span> room <span class="token operator">+</span> <span class="token string">'!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  isChannelReady <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>最后，以下 JavaScript 说明了客户端如何意识到自己在扮演 Joiner 的角色，因为它返回了对 create 或 join 请求的连接响应：</p> <p><img src="/webrtc-book-cn/assets/img/rcwr_0509.c1487692.png" alt="图5-9"></p> <p>图5-9 Joiner 加入频道</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Handle 'joined' message coming back from server:</span>
<span class="token comment">// this is the second peer joining the channel</span>
socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'joined'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">room</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'This peer has joined room '</span> <span class="token operator">+</span> room<span class="token punctuation">)</span><span class="token punctuation">;</span>
  isChannelReady <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="/webrtc-book-cn/assets/img/rcwr_0510.51d36dbf.png" alt="图5-10"></p> <p>图5-10 信令服务器管理 Joiner 的请求</p> <p>从这一点开始， Joiner 在协商的此阶段执行的其余操作与我们在上一节中查看 Initiator 的角色时所描述的操作完全相同：</p> <ol><li>访问本地媒体（等待用户的访问） 同意）</li> <li>将本地视频附加到 HTML 页面</li> <li>通过信令服务器将获取的用户媒体消息发送给远程对等体</li></ol> <h2 id="initiator-开始协商"><a href="#initiator-开始协商" class="header-anchor">#</a> Initiator 开始协商</h2> <p>接收到服务器中继的用户媒体消息后，发起者将再次激活 <code>checkAndStart()</code> 函数，由于边界条件现在已更改，因此这一次实际上已执行：通道已准备就绪，本地流已 由 <code>getUserMedia()</code> API 调用提供。</p> <p>图5-11 中的 UML 快照和以下 JavaScript 代码指示发起方（1）创建了 <code>PeerConnection</code> 对象； （2）将频道标记为已开始； （3）激活 <code>doCall()</code> JavaScript 函数。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Channel negotiation trigger function</span>
<span class="token keyword">function</span> <span class="token function">checkAndStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isStarted <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> localStream <span class="token operator">!=</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span> isChannelReady<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">createPeerConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    isStarted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isInitiator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">doCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>深入研究上述操作的详细信息，以下代码摘录显示，为正确管理 ICE 候选地址以及远程流的添加和删除，<code>PeerConnection</code> 对象附加了许多处理程序。
此外，<code>PeerConnection</code> 还配备了一个数据通道，该通道将用于以对等方式与 Joiner 交换文本数据：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">createPeerConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    pc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RTCPeerConnection</span><span class="token punctuation">(</span>pc_config<span class="token punctuation">,</span> pc_constraints<span class="token punctuation">)</span><span class="token punctuation">;</span>

    pc<span class="token punctuation">.</span><span class="token function">addStream</span><span class="token punctuation">(</span>localStream<span class="token punctuation">)</span><span class="token punctuation">;</span>

    pc<span class="token punctuation">.</span>onicecandidate <span class="token operator">=</span> handleIceCandidate<span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Created RTCPeerConnnection with:\n'</span> <span class="token operator">+</span> <span class="token string">'  config: \''</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>pc_config<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\';\n'</span> <span class="token operator">+</span> <span class="token string">'  constraints: \''</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>pc_constraints<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Failed to create PeerConnection, exception: '</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Cannot create RTCPeerConnection object.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  pc<span class="token punctuation">.</span>onaddstream <span class="token operator">=</span> handleRemoteStreamAdded<span class="token punctuation">;</span>
  pc<span class="token punctuation">.</span>onremovestream <span class="token operator">=</span> handleRemoteStreamRemoved<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>isInitiator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// Create a reliable data channel</span>
      sendChannel <span class="token operator">=</span> pc<span class="token punctuation">.</span><span class="token function">createDataChannel</span><span class="token punctuation">(</span><span class="token string">&quot;sendDataChannel&quot;</span><span class="token punctuation">,</span><span class="token punctuation">{</span>reliable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">'Created send data channel'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Failed to create data channel. '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">'createDataChannel() failed with exception: '</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    sendChannel<span class="token punctuation">.</span>onopen <span class="token operator">=</span> handleSendChannelStateChange<span class="token punctuation">;</span>
    sendChannel<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> handleMessage<span class="token punctuation">;</span>
    sendChannel<span class="token punctuation">.</span>onclose <span class="token operator">=</span> handleSendChannelStateChange<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// Joiner</span>
    pc<span class="token punctuation">.</span>ondatachannel <span class="token operator">=</span> gotReceiveChannel<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/webrtc-book-cn/assets/img/rcwr_0511.205956ca.png" alt="图5-11"></p> <p>图5-11 Initiator 开始协商</p> <p>关于 <code>doCall()</code> 函数，它基本上在可用的 <code>PeerConnection</code> 上调用 <code>createOffer()</code> 方法，要求浏览器正确构建一个 SDP （会话描述协议）对象，该对象代表发起方的媒体和要传达给远程方的功能：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">doCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Creating Offer...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  pc<span class="token punctuation">.</span><span class="token function">createOffer</span><span class="token punctuation">(</span>setLocalAndSendMessage<span class="token punctuation">,</span> onSignalingError<span class="token punctuation">,</span> sdpConstraints<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>与此调用关联的成功处理程序负责将浏览器提供的 SDP 与 <code>PeerConnection</code> 相关联，并通过信令服务器将其传输到远程对等方：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">setLocalAndSendMessage</span><span class="token punctuation">(</span><span class="token parameter">sessionDescription</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  pc<span class="token punctuation">.</span><span class="token function">setLocalDescription</span><span class="token punctuation">(</span>sessionDescription<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sendMessage</span><span class="token punctuation">(</span>sessionDescription<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="joiner-管理-initiator-的-offer"><a href="#joiner-管理-initiator-的-offer" class="header-anchor">#</a> Joiner 管理 Initiator 的 <code>offer</code></h2> <p>图5-12 显示了 Joiner 在收到发起者的 SDP offer 后采取的操作。</p> <p>实际上，如下面的 JavaScript 代码片段所示，当 offer 到达 Joiner 时，首先运行 <code>checkAndStart()</code> 函数：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Receive message from the other peer via the signalling server</span>
socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Received message:'</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>message <span class="token operator">===</span> <span class="token string">'got user media'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token operator">...</span>

  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'offer'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isInitiator <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isStarted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">checkAndStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      pc<span class="token punctuation">.</span><span class="token function">setRemoteDescription</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RTCSessionDescription</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">doAnswer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'answer'</span> <span class="token operator">&amp;&amp;</span> isStarted<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token operator">...</span>
</code></pre></div><p><img src="/webrtc-book-cn/assets/img/rcwr_0512.70518e34.png" alt="图5-12"></p> <p>图5-12 参加 Initiator 的 offer 后，Joiner 的操作</p> <p>当由 Joiner 执行时，此函数将创建 Joiner 的 <code>PeerConnection</code> 对象并设置 <code>isStarted</code> 标志：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">checkAndStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isStarted <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> localStream <span class="token operator">!=</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span> isChannelReady<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">createPeerConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    isStarted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isInitiator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如第121页 的 “ Joiner 的 <code>answer</code> ” 中所述，一旦使用 <code>checkAndStart()</code> 函数完成，Joiner 仍然必须配置其本地 <code>PeerConnection</code> 并正确构建 SDP <code>answer</code> 以发送回发起方。 在下文中，我们将首先简要讨论双方所需的 ICE 候选人交换程序。</p> <h2 id="ice-候选人交换"><a href="#ice-候选人交换" class="header-anchor">#</a> ICE 候选人交换</h2> <p>正如我们已经预料到的，信令服务器的主要任务之一是使发起方和连接方之间的网络可达性信息能够交换，从而可以在两者之间建立媒体包流。
交互式连接建立（ICE）<a href="https://tools.ietf.org/html/rfc5245" target="_blank" rel="noopener noreferrer">RFC5245<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 技术允许对等方发现有关彼此拓扑的足够信息，从而有可能在彼此之间找到一条或多条通信路径。</p> <p>此类信息由与每个 <code>RTCPeerConnection</code> 对象关联的 ICE 代理在本地收集。 ICE 代理负责：</p> <ul><li>收集本地IP，端口元组候选</li> <li>在同级之间执行连接检查</li> <li>发送连接保持活动</li></ul> <p>设置会话描述（本地或远程）后，本地 ICE 代理会自动开始发现本地对等方所有可能候选者的过程：</p> <ol><li>ICE 代理向操作系统查询本地 IP 地址。</li> <li>如果已配置，它将查询外部 STUN 服务器以检索对等方的公共 IP 地址和端口元组。</li> <li>如果已配置，则代理还将 TURN 服务器用作最后的手段。 如果对等连接检查失败，则媒体流将通过 TURN 服务器进行中继。</li></ol> <p>每当发现新的候选对象（即IP，port tuple）时，ICE 代理就会自动将其注册到 <code>RTCPeerConnection</code> 对象，并通过回调函数（<code>onIceCandidate</code>）通知应用程序。 该应用程序可以决定在发现每个候选者之后（Trickle ICE）尽快将其转移到远程方，或者决定等待 ICE 收集阶段完成，然后立即发送所有候选者。</p> <p>与该特定阶段关联的事件顺序如 图5-13 所示。</p> <p><img src="/webrtc-book-cn/assets/img/rcwr_0513.359bf373.png" alt="图5-13"></p> <p>图5-13 服务器引导的 ICE 候选人交换</p> <p>该图显示，只要浏览器引发 <code>IceCandidate</code> 事件（因为已经收集了一个新的 ICE 候选对象），就会激活 <code>handleIceCandidate()</code> 处理程序。 此处理程序将检索到的候选者包装在专用候选者消息中，该消息将通过服务器发送给远程方：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">handleIceCandidate</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'handleIceCandidate event: '</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>candidate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token string">'candidate'</span><span class="token punctuation">,</span>label<span class="token operator">:</span> event<span class="token punctuation">.</span>candidate<span class="token punctuation">.</span>sdpMLineIndex<span class="token punctuation">,</span>id<span class="token operator">:</span> event<span class="token punctuation">.</span>candidate<span class="token punctuation">.</span>sdpMid<span class="token punctuation">,</span>candidate<span class="token operator">:</span> event<span class="token punctuation">.</span>candidate<span class="token punctuation">.</span>candidate<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'End of candidates.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>像往常一样，服务器只是充当两个协商方之间的中介者，如 图5-14 中的控制台快照所示，它显示了服务器如何中继发起方发送的 SDP 描述和中继方检索到的 ICE 候选地址。 两个相互作用的同伴。</p> <p><img src="/webrtc-book-cn/assets/img/rcwr_0514.1761c32a.png" alt="图5-14"></p> <p>图5-14 服务器引导的协商日志</p> <p>最后，下面显示的 JavaScript 代码段指示两个对等点一从信令服务器到达，便立即将接收到的候选者添加到其自己的 <code>PeerConnection</code> 对象中：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Receive message from the other peer via the signaling server</span>
socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Received message:'</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>message <span class="token operator">===</span> <span class="token string">'got user media'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'offer'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'answer'</span> <span class="token operator">&amp;&amp;</span> isStarted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'candidate'</span> <span class="token operator">&amp;&amp;</span> isStarted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> candidate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RTCIceCandidate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        sdpMLineIndex<span class="token operator">:</span> message<span class="token punctuation">.</span>label<span class="token punctuation">,</span>
        candidate<span class="token operator">:</span>message<span class="token punctuation">.</span>candidate
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      pc<span class="token punctuation">.</span><span class="token function">addIceCandidate</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message <span class="token operator">===</span> <span class="token string">'bye'</span> <span class="token operator">&amp;&amp;</span> isStarted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>一旦其他对等方收到 ICE 候选对象，便在 <code>RTCPeerConnection</code> 对象（<code>setRemoteDescription</code>）上设置了远程会话描述，因此 ICE 代理可以开始执行连接检查以查看它是否可以到达其他对等方。</p> <p>此时，每个 ICE 代理都有其候选人和其同行候选人的完整列表。 将它们配对。 为了查看哪个对有效，每个代理计划安排一系列优先检查：首先检查本地 IP 地址，然后检查公共 IP 地址，最后使用 TURN。 每次检查都是客户端将通过从本地候选者向远程候选者发送 STUN 请求而对特定候选对执行的 STUN request/response 事务。</p> <p>如果一对候选对象中的一个可行，则存在用于点对点连接的路由路径。 相反，如果所有候选项均失败，则 <code>RTCPeerConnection</code> 被标记为失败，或者连接回退到 TURN 中继服务器以建立连接。</p> <p>建立连接后，ICE 代理会继续向其他对等方发出定期的 STUN 请求。 这用作连接保持活动状态。</p> <hr> <blockquote><h4 id="ice-流-trickle-ice"><a href="#ice-流-trickle-ice" class="header-anchor">#</a> ICE 流 (Trickle ICE)</h4> <p>ICE 流是 ICE 协议的推荐扩展，在此协议中，无需等待 ICE 收集过程完成，就可以向其他对等方发送增量更新。 这有助于加快整个设置阶段。</p> <p>ICE 流 机制涉及以下步骤：</p> <ul><li>双方交换没有 ICE 候选人的 SDP offer</li> <li>一旦发现 ICE 候选者，便通过信令信道发送它们。</li> <li>只要有新的候选者描述，便会运行 ICE 连接检查。</li></ul></blockquote> <hr> <h2 id="joiner-的-answer"><a href="#joiner-的-answer" class="header-anchor">#</a> Joiner 的 <code>answer</code></h2> <p>既然我们已经完成了 ICE 候选人交换，那么让我们重新思考一下。
我们当时（第115页上的“ Joiner 管理 Initiator 的 Offer ”）是 Joiner 通过创建自己的 <code>PeerConnection</code> 对象来处理 Initiator 的 Offer 的时候。
如 图5-15 所示，完成此操作后，Joiner 首先将接收到的 SDP 与新实例化的 <code>PeerConnection</code> 相关联，然后立即调用 <code>doAnswer()</code> JavaScript 函数。</p> <p><img src="/webrtc-book-cn/assets/img/rcwr_0515.c18b94eb.png" alt="图5-15"></p> <p>图5-15 Joiner’s Answer to Initiator’s Offer</p> <p>下面的代码片段突出显示了 Joiner 算法的这一特定部分：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Receive message from the other peer via the signaling server</span>
socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Received message:'</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>message <span class="token operator">===</span> <span class="token string">'got user media'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'offer'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    pc<span class="token punctuation">.</span><span class="token function">setRemoteDescription</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RTCSessionDescription</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">doAnswer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'answer'</span> <span class="token operator">&amp;&amp;</span> isStarted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">...</span>
</code></pre></div><p><code>doAnswer()</code> 函数基本上处理与接收到的 Offer 关联的 SDP Answer 的创建：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">doAnswer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Sending answer to peer.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  pc<span class="token punctuation">.</span><span class="token function">createAnswer</span><span class="token punctuation">(</span>setLocalAndSendMessage<span class="token punctuation">,</span>onSignalingError<span class="token punctuation">,</span> sdpConstraints<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>与 <code>createOffer()</code> 方法类似，一旦浏览器使本地 SDP 可用， <code>createAnswer()</code> 调用将设置成功处理程序，该处理程序将被调用。 这种处理程序的作用是首先将浏览器提供的 SDP 设置为与 Joiner 的 <code>PeerConnection</code> 相关联的本地会话描述，然后通过信令服务器将此类描述发送给远程方：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">setLocalAndSendMessage</span><span class="token punctuation">(</span><span class="token parameter">sessionDescription</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  pc<span class="token punctuation">.</span><span class="token function">setLocalDescription</span><span class="token punctuation">(</span>sessionDescription<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sendMessage</span><span class="token punctuation">(</span>sessionDescription<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当启动器从服务器接收到 Joiner's Answer 时，可以将其正确设置为与其本地 <code>PeerConnection</code> 对象关联的远程会话描述：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Receive message from the other peer via the signaling server</span>
socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Received message:'</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>message <span class="token operator">===</span> <span class="token string">'got user media'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'offer'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'answer'</span> <span class="token operator">&amp;&amp;</span> isStarted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pc<span class="token punctuation">.</span><span class="token function">setRemoteDescription</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RTCSessionDescription</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'candidate'</span> <span class="token operator">&amp;&amp;</span> isStarted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message <span class="token operator">===</span> <span class="token string">'bye'</span> <span class="token operator">&amp;&amp;</span> isStarted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="开始点对点"><a href="#开始点对点" class="header-anchor">#</a> 开始点对点！</h2> <p>我们终于准备好了！ 两个对等方已成功交换会话描述和网络可达性信息。 借助信令服务器的中介，已经正确设置和配置了两个 <code>PeerConnection</code> 对象。 如 图5-16 所示，双向多媒体通信通道现在可用作两个浏览器之间的直接传输工具。 现在服务器已完成其任务，并且此后将被两个通信对等方完全绕开。</p> <p><img src="/webrtc-book-cn/assets/img/rcwr_0516.50459e07.png" alt="图5-16"></p> <p>图5-16 点对点建立后进行通讯</p> <p>成功进行渠道协商后，图5-17 和 图5-18 中的两个快照分别显示了 Joiner 和 Initiator 的窗口。 您可以在两个图中看到，每个对等方现在都具有可用的本地视图和远程视图，以及可以分别用于向远程用户发送直接消息和记录从远程用户接收的直接消息的两个文本区域。</p> <p><img src="images/rcwr_0517.png" alt="图5-17"></p> <p>图5-17 在 Chrome 中建立了通信：Joiner</p> <p><img src="images/rcwr_0518.png" alt="图5-18"></p> <p>图5-18 在 Chrome 中建立通信：Initiator</p> <h3 id="使用-data-channel"><a href="#使用-data-channel" class="header-anchor">#</a> 使用 Data Channel</h3> <p>在本小节中，我们将深入研究配置和使用数据通道的细节。实际上，数据通道是由启动器创建的，它是 <code>createPeerConnection()</code> 函数代码的一部分：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">createPeerConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    pc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RTCPeerConnection</span><span class="token punctuation">(</span>pc_config<span class="token punctuation">,</span> pc_constraints<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>

  pc<span class="token punctuation">.</span>onaddstream <span class="token operator">=</span> handleRemoteStreamAdded<span class="token punctuation">;</span>
  pc<span class="token punctuation">.</span>onremovestream <span class="token operator">=</span> handleRemoteStreamRemoved<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>isInitiator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// Create a reliable data channelsendChannel = pc.createDataChannel(&quot;sendDataChannel&quot;,{</span>
      reliable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">'Created send data channel'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span>

    sendChannel<span class="token punctuation">.</span>onopen <span class="token operator">=</span> handleSendChannelStateChange<span class="token punctuation">;</span>
    sendChannel<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> handleMessage<span class="token punctuation">;</span>
    sendChannel<span class="token punctuation">.</span>onclose <span class="token operator">=</span> handleSendChannelStateChange<span class="token punctuation">;</span>

  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// Joiner</span>
    pc<span class="token punctuation">.</span>ondatachannel <span class="token operator">=</span> gotReceiveChannel<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面的代码片段显示了如何将多个处理程序与数据通道相关联。 例如，我们在 <code>handleSendChannelStateChange()</code> 函数下方显示该函数，该函数负责在通道达到打开状态后立即启用发送者的文本区域和 “发送” 按钮：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">handleSendChannelStateChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> readyState <span class="token operator">=</span> sendChannel<span class="token punctuation">.</span>readyState<span class="token punctuation">;</span>
  <span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">'Send channel state is: '</span> <span class="token operator">+</span> readyState<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>readyState <span class="token operator">==</span> <span class="token string">&quot;open&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dataChannelSend<span class="token punctuation">.</span>disabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    dataChannelSend<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dataChannelSend<span class="token punctuation">.</span>placeholder <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    sendButton<span class="token punctuation">.</span>disabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    dataChannelSend<span class="token punctuation">.</span>disabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    sendButton<span class="token punctuation">.</span>disabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>下面显示的 <code>sendData()</code> JavaScript 函数配置为 “发送” 按钮的处理程序，并执行以下操作：（1）收集用户在 <code>sendTextArea</code> 中插入的文本； （2）通过实例化数据通道发送此类文本。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Handler associated with Send button</span>
sendButton<span class="token punctuation">.</span>onclick <span class="token operator">=</span> sendData<span class="token punctuation">;</span>
<span class="token operator">...</span>
<span class="token keyword">function</span> <span class="token function">sendData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> data <span class="token operator">=</span> sendTextarea<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>isInitiator<span class="token punctuation">)</span> sendChannel<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> receiveChannel<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">'Sent data: '</span> <span class="token operator">+</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>图5-19 显示了通过数据通道发送文本消息之后的发起方窗口。</p> <p><img src="images/rcwr_0519.png" alt="图5-19"></p> <p>图5-19 使用数据通道：Initiator</p> <p>消息到达另一侧后，将触发 <code>handleMessage()</code> 函数，如下所示，该函数仅获取已传输的数据并将其记录在 HTML 页面的 <code>receiveTextArea</code> 元素中：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">'Received message: '</span> <span class="token operator">+</span> event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  receiveTextarea<span class="token punctuation">.</span>value <span class="token operator">+=</span> event<span class="token punctuation">.</span>data <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这也显示在 图5-20 中的快照中。</p> <p><img src="images/rcwr_0520.png" alt="图5-20"></p> <p>图5-20 使用数据通道：加入方</p> <p>转到接收频道， Joiner 的浏览器引发 <code>dataChannel</code> 事件后，就会激活 <code>getReceiveChannel()</code> 函数。 该处理程序设置接收通道并正确配置它以管理与通道相关的事件：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">gotReceiveChannel</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">'Receive Channel Callback'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  receiveChannel <span class="token operator">=</span> event<span class="token punctuation">.</span>channel<span class="token punctuation">;</span>
  receiveChannel<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> handleMessage<span class="token punctuation">;</span>
  receiveChannel<span class="token punctuation">.</span>onopen <span class="token operator">=</span> handleReceiveChannelStateChange<span class="token punctuation">;</span>
  receiveChannel<span class="token punctuation">.</span>onclose <span class="token operator">=</span> handleReceiveChannelStateChange<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>图5-21 和 图5-22 分别显示了 Joiner 通过数据通道将答案发送回 Initiator ， Initiator 接收答案并将其记录在数据通道文本区域内。</p> <p><img src="images/rcwr_0521.png" alt="图5-21"></p> <p>图5-21 Data channel: Joiner 回答 Initiator 的消息</p> <p><img src="images/rcwr_0522.png" alt="图5-22"></p> <p>图5-22 Data channel: Initiator 获得 Joiner 的回答</p> <h2 id="快速浏览-chrome-webrtc-内部工具"><a href="#快速浏览-chrome-webrtc-内部工具" class="header-anchor">#</a> 快速浏览 Chrome WebRTC 内部工具</h2> <p>在最后一部分中，我们将提供有关 Google Chrome 提供的特定于 WebRTC 的调试工具的信息。 确实，当您使用支持 WebRTC 的网络应用程序时，可以通过打开一个新标签页并在该标签页的位置栏中输入 <code>chrome://webrtc-internals/</code> 来监视其状态。 对于我们的示例应用程序，图5-23 给出了 <code>webrtc-internals</code> 选项卡的快照。</p> <p><img src="/webrtc-book-cn/assets/img/rcwr_0523.54cdd237.png" alt="图5-23"></p> <p>图5-23 活动的 PeerConnections</p> <p>如图所示，日志记录页面报告有关活动 <code>PeerConnection</code> 对象的信息。 在本例中，由于我们在同一台计算机上同时运行 Initiator 和 Joiner ，因此我们看到了两个活动的 <code>PeerConnection</code> 实例，分别与 Initiator （<code>PeerConnection</code> 71221-1）和 Joiner （<code>PeerConnection</code> 71229-1）关联。 通过单击报告的标识符之一，将显示有关相关 <code>PeerConnection</code> 的详细信息。 例如，图5-24 和 图5-25 分别以 SDP 对象的形式显示了发起者的 Offer 和相应的 Joiner 的 Answer 。 在同一图中，您还可以看到浏览器在处理呼叫时生成的所有事件的列表。</p> <p><img src="/webrtc-book-cn/assets/img/rcwr_0524.2336b55f.png" alt="图5-24"></p> <p>图5-24 SDP Offer</p> <p><img src="/webrtc-book-cn/assets/img/rcwr_0525.c2947266.png" alt="图5-25"></p> <p>图5-25 SDP Answer</p> <p>Chrome 也非常擅长报告点对点交换所涉及的所有媒体的渠道统计信息。 例如，您可以在 图5-26 中看到针对音频，视频和数据通道报告了通道信息（通道创建时间戳，处理通道的浏览器组件，用于安全信息交换的本地和远程通道证书）。</p> <p><img src="/webrtc-book-cn/assets/img/rcwr_0526.1330c788.png" alt="图5-26"></p> <p>图5-26 Channel 统计 文字格式</p> <p>相反， 图5-27 以图形格式报告有关网络相关的详细信息（估计可用带宽，每秒发送的数据包，平均往返时间等）以及与编码相关的详细信息（目标编码比特率，实际编码比特） 速率等）有关媒体（即音频和视频）流的信息。</p> <p><img src="/webrtc-book-cn/assets/img/rcwr_0527.cce2a844.png" alt="图5-27"></p> <p>图5-27 Channel 统计 图形格式</p> <p>最后，图5-28 说明了浏览器实际上是如何负责跟踪 ICE 协议机器状态更改以及为上层应用程序生成相关事件的。</p> <p><img src="/webrtc-book-cn/assets/img/rcwr_0528.0ee74edd.png" alt="图5-28"></p> <p>图5-28 信令状态机与 ICE 候选事件</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/webrtc-book-cn/04_the-need-for-a-signaling-channel.html" class="prev">
        第4章 需要信令通道
      </a></span> <span class="next"><a href="/webrtc-book-cn/06_advanced_features.html">
        第6章 WebRTC API 的高级功能简介
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/webrtc-book-cn/assets/js/app.2e33468f.js" defer></script><script src="/webrtc-book-cn/assets/js/2.f12a4af1.js" defer></script><script src="/webrtc-book-cn/assets/js/4.d764a0db.js" defer></script>
  </body>
</html>
